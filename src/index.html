<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>google-sheets Demo</title>
    <script src="../bower_components/platform/platform.js"></script>
    <link rel="import" href="../bower_components/google-sheets/google-sheets.html" />
    <link rel="import" href="../bower_components/google-map/google-map.html" />
    <link rel="import" href="../bower_components/core-selector/core-selector.html" />
    <link rel="import" href="../bower_components/core-collapse/core-collapse.html" />
    <link rel="import" href="../bower_components/core-overlay/core-overlay.html" />
  </head>
  <body unresolved>
    <polymer-element name="phl-pac-complaints">
      <template>
        <style>
          * {
            margin: 0;
            padding: 0;
          }

          :host {
            height: 100%;
            font-family: helvetica, arial, sans-serif;
            color: #333;
            font-size: 12px;
            line-height: 16px;
          }

          h1 {
            font-size: 16px;
            margin-bottom: 5px;
            line-height: 18px;
          }

          h2 {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
            padding-bottom: 5px;
            font-style: italic;
            border-bottom: 1px solid #ddd;
          }

          h3 {
            cursor: pointer;
            border: 1px solid #ccc;
            line-height: 26px;
            padding-left: 5px;
            margin-top: -1px;
            background: #eee;
          }

          p {
            margin-bottom: 15px;
          }

          span.filter {
            display: block;
            border: 1px solid #ccc;
            border-bottom: none;
            line-height: 24px;
            padding-left: 5px;
          }

          span.filter-0 {
            margin-top: -1px;
          }

          span[active] {
            font-weight: bold;
          }

          span[active]:after {
            content: "\2713";
            float: right;
            margin-right: 5px;
          }

          span.filter:hover {
            cursor: pointer;
          }

          span.filter-by {
            display: block;
            margin-bottom: 5px;
          }

          span.clear-all {
            float: right;
            margin-top: -20px;
          }

          span.clear-all:before {
            content: "x";
            margin-right: 3px;
          }

          button.about {
            margin-top: 10px;
          }

          google-map {
            display: block;
            height: 100%;
          }

          core-collapse {
            margin-bottom: 10px;
            border-bottom: 1px solid #ccc;
          }

          .controls {
            width: 250px;
            padding: 10px;
            background: #fff;
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
          }

          select {
            width: 100%;
            margin-bottom: 3px;
          }

          button {
            background: none;
            border: none;
            text-decoration: underline;
          }

          button:hover {
            cursor: pointer;
          }

        </style>
        <section class="controls">
          <h1>Philadelphia Police Advisory Commission Complaints</h1>
          <h2>2009 &ndash; 2012</h2>

          <span class="filter-by">Filter by:</span>
          <span on-click="{{ renderAll }}" class="clear-all">clear</span>

          <template id="filters" repeat="{{ filters }}" bind>
            <h3 on-click="{{ toggleDropdown }}" trait="{{ trait }}">{{ capitalizedTrait }}</h3>
            <core-collapse id="collapse-{{ trait }}">
              <core-selector on-core-select="{{ applyFilters }}" valueattr="label">
                <template repeat="{{ value, i in values }}">
                  <span class="filter filter-{{ i }}" trait="{{ trait }}" label="{{ value }}">{{ value }}</span>
                </template>
              </core-selector>
            </core>
          </template>

          <ul class="fine-print">
            <li class="about" on-click="{{ toggleOverlay }}">About</li>
            <li><a href="http://www.mikeball.info">2014 MDB</a></li>
          </ul>

          <core-overlay id="overlay" layered backdrop>
            <style>
              #description {
                background: #fff;
                width: 500px;
                padding: 20px;
              }

              #description p {
                font-size: 16px;
                line-height: 22px;
              }
            </style>
            <div id="description">
              <h2>About</h2>
              <p>This map plots 2009 &ndash; 2012 complaints filed with the Philadelphia Police Advisory Commission by citizens against Philadelphia Police officers. Click a marker to view complaint details.</p>
              <p>The data is published by <a href="http://www.opendataphilly.org/opendata/resource/218/philadelphia-police-advisory-commission-complaints/">Open Data Philly</a> and has been imported to a public <a href="https://docs.google.com/spreadsheet/ccc?key=0Aii0ITjxvJ6fdFlPNHVINHY2dVhfODNsY2JWU0U0NHc&usp=sharing">Google Spreadsheet</a>. According to Open Data Philly, the data comes directly from the Police Advisory Commission Complaint Database.</p>
              <p>The data does not include additional complaints filed with Philadelphia Police Internal Affairs.</p>
              <p>Please reference the application's <a href="https://docs.google.com/spreadsheet/ccc?key=0Aii0ITjxvJ6fdFlPNHVINHY2dVhfODNsY2JWU0U0NHc#gid=0">Google Spreadsheet</a>, <a href="http://github.com/mdb/phl-pac-complaint-browser">source code</a> and <a href="http://www.opendataphilly.org/opendata/resource/218/philadelphia-police-advisory-commission-complaints/">Open Data Philly's PAC Complaints data</a> in accessing data integrity and accuracy. Defects can be logged on <a href="https://github.com/mdb/phl-pac-complaint-browser/issues">Github</a>.</p>
            </div>
          </core-overlay>

        </section>

        <google-sheets id="sheet" key="0Aii0ITjxvJ6fdFlPNHVINHY2dVhfODNsY2JWU0U0NHc" published></google-sheets>

        <template id="rows" bind>
          <google-map latitude="39.99" longitude="-75.150" zoom="12" disableDefaultUI zoomable="true">

          <template repeat="{{rows}}">
            <google-map-marker latitude="{{gsx$latitude.$t}}" longitude="{{gsx$longitude.$t}}">
              <table>
                <tr>
                  <td>Type</td>
                  <td>{{gsx$type.$t}}</td>
                </tr>
                <tr>
                  <td>Unit</td>
                  <td>{{gsx$unit.$t}}</td>
                </tr>
                <tr>
                  <td>Age</td>
                  <td>{{gsx$age.$t}}</td>
                </tr>
                <tr>
                  <td>Race</td>
                  <td>{{gsx$race.$t}}</td>
                </tr>
                <tr>
                  <td>Sex</td>
                  <td>{{gsx$sex.$t}}</td>
                </tr>
                <tr>
                  <td>Action</td>
                  <td>{{gsx$action.$t}}</td>
                </tr>
                <tr>
                  <td>Status</td>
                  <td>{{gsx$status.$t}}</td>
                </tr>
              </table>
            </google-map-marker>
          </template>
          </google-map>
        </template>
      </template>
    <polymer-element>
  </body>

  <script>
    Polymer('phl-pac-complaints', {
      ready: function () {
        var self = this;

        self.$.sheet.addEventListener('google-sheet-data', function(e) {
          self.appliedFilters = {};
          self.complaints = this.rows;
          self.$.rows.model = this;
          self.$.filters.model = { filters: self.buildFilters(this.rows) };
        });
      },

      renderAll: function () {
        this.activeFilters = {};
        this.$.rows.model.rows = this.complaints;
      },

      applyFilters: function (evt, detail, elem) {
        var property = this.propertyName(detail.item.getAttribute('trait'));

        this.appliedFilters[property] = detail.item.getAttribute('label');
        this.filterComplaints();
      },

      filterComplaints: function () {
        var filteredComplaints = this.complaints,
            self = this,
            trait;

        for (trait in this.appliedFilters) {
          filteredComplaints = filteredComplaints.filter(function (complaint) {
            return complaint[trait]['$t'] === self.appliedFilters[trait];
          });
        }

        this.$.rows.model.rows = filteredComplaints;
      },

      buildFilters: function (data) {
        var filterables = ['race', 'sex', 'type', 'unit', 'action', 'status'],
            filters = [],
            self = this;

        filterables.forEach(function (filter) {
          filters.push(self.buildFilterObj(filter, data));
        });

        return filters;
      },

      buildFilterObj: function (property, data) {
        return {
          trait: property,
          capitalizedTrait: this.capitalize(property),
          values: this.getUniqueValues(property, data)
        };
      },

      capitalize: function (str) {
        return str.charAt(0).toUpperCase() + str.slice(1)
      },

      getUniqueValues: function (property, data) {
        var flags = [],
            output = [],
            propertyName = this.propertyName(property),
            value;

        data.forEach(function (item) {
          value = item[propertyName]['$t'];

          if (flags[value] || value === '') { return; }

          flags[value] = true;

          output.push(value);
        });

        return output;
      },

      propertyName: function (property) {
        return 'gsx$' + property;
      },

      toggleDropdown: function (evt, detail, sender) {
        var trait = sender.getAttribute('trait');

        this.shadowRoot.querySelector('#collapse-' + trait).toggle();
      },

      toggleOverlay: function () {
        this.$.overlay.toggle();
        return false;
      }
    });
  </script>
</html>
